AWSTemplateFormatVersion: '2010-09-09'
Resources:
  AppSyncApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: GuestCheckinAPI
      AuthenticationType: AWS_IAM

  GuestTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: roomNumber
          AttributeType: S
      KeySchema:
        - AttributeName: roomNumber
          KeyType: HASH
      TableName: guest-checkin-table

  AppSyncSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Definition: |
        type Guest {
          roomNumber: String! 
          name: String!
          address: String!
          phone: String!
          occupation: String
          nationality: String!
          passportImageUrl: String
          checkInDate: AWSDate!
          checkOutDate: AWSDate!
          approvalStatus: String! # pending, approved, rejected
          promoConsent: Boolean! # Consent for promotional communications
          createdAt: AWSDateTime
          updatedAt: AWSDateTime
        }

        input CreateGuestInput {
          roomNumber: String!
          name: String!
          address: String!
          phone: String!
          occupation: String
          nationality: String!
          passportImageUrl: String
          checkInDate: AWSDate!
          checkOutDate: AWSDate!
          promoConsent: Boolean!
        }

        input UpdateGuestInput {
          roomNumber: String!  # ← 必須にする（プライマリキー）
          name: String
          address: String
          phone: String
          occupation: String
          nationality: String
          approvalStatus: String
          passportImageUrl: String
          checkInDate: AWSDate
          checkOutDate: AWSDate
          promoConsent: Boolean
        }

        type Mutation {
          createGuest(input: CreateGuestInput!): Guest
          updateGuest(input: UpdateGuestInput!): Guest
        }

        type Query {
          getGuest(roomNumber: String!): Guest
          listGuests: [Guest]
        }

  GuestTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: guestcheckintable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncDynamoDBRole.Arn
      DynamoDBConfig:
        TableName: !Ref GuestTable
        AwsRegion: !Ref AWS::Region

  AppSyncDynamoDBRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess

  CreateGuestResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createGuest
      DataSourceName: !GetAtt GuestTableDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "PutItem",
          "key": {
            "roomNumber": $util.dynamodb.toDynamoDBJson($ctx.args.input.roomNumber)
          },
          "attributeValues": {
            "name": $util.dynamodb.toDynamoDBJson($ctx.args.input.name),
            "address": $util.dynamodb.toDynamoDBJson($ctx.args.input.address),
            "phone": $util.dynamodb.toDynamoDBJson($ctx.args.input.phone),
            "occupation": $util.dynamodb.toDynamoDBJson($util.defaultIfNull($ctx.args.input.occupation, "")),
            "nationality": $util.dynamodb.toDynamoDBJson($ctx.args.input.nationality),
            "passportImageUrl": $util.dynamodb.toDynamoDBJson($util.defaultIfNull($ctx.args.input.passportImageUrl, "")),
            "checkInDate": $util.dynamodb.toDynamoDBJson($ctx.args.input.checkInDate),
            "checkOutDate": $util.dynamodb.toDynamoDBJson($ctx.args.input.checkOutDate),
            "approvalStatus": $util.dynamodb.toDynamoDBJson("pending"),
            "createdAt": $util.dynamodb.toDynamoDBJson($util.time.nowISO8601()),
            "updatedAt": $util.dynamodb.toDynamoDBJson($util.time.nowISO8601()),
            "promoConsent": $util.dynamodb.toDynamoDBJson($ctx.args.input.promoConsent)
          }
        }
      ResponseMappingTemplate: |
        $util.toJson($ctx.result)

  UpdateGuestResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateGuest
      DataSourceName: !GetAtt GuestTableDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "UpdateItem",
          "key": {
            "roomNumber": $util.dynamodb.toDynamoDBJson($ctx.args.input.roomNumber)
          },
          "update": {
            "expression": "SET #updatedAt = :updatedAt",
            "expressionNames": {
              "#updatedAt": "updatedAt"
            },
            "expressionValues": {
              ":updatedAt": $util.dynamodb.toDynamoDBJson($util.time.nowISO8601())
            }
            #if($ctx.args.input.name)
              #set($expression = "$expression, #name = :name")
              #set($expressionNames["#name"] = "name")
              #set($expressionValues[":name"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.name))
            #end
            #if($ctx.args.input.address)
              #set($expression = "$expression, #address = :address")
              #set($expressionNames["#address"] = "address")
              #set($expressionValues[":address"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.address))
            #end
            #if($ctx.args.input.phone)
              #set($expression = "$expression, #phone = :phone")
              #set($expressionNames["#phone"] = "phone")
              #set($expressionValues[":phone"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.phone))
            #end
            #if($ctx.args.input.occupation)
              #set($expression = "$expression, #occupation = :occupation")
              #set($expressionNames["#occupation"] = "occupation")
              #set($expressionValues[":occupation"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.occupation))
            #end
            #if($ctx.args.input.nationality)
              #set($expression = "$expression, #nationality = :nationality")
              #set($expressionNames["#nationality"] = "nationality")
              #set($expressionValues[":nationality"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.nationality))
            #end
            #if($ctx.args.input.passportImageUrl)
              #set($expression = "$expression, #passportImageUrl = :passportImageUrl")
              #set($expressionNames["#passportImageUrl"] = "passportImageUrl")
              #set($expressionValues[":passportImageUrl"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.passportImageUrl))
            #end
            #if($ctx.args.input.checkInDate)
              #set($expression = "$expression, #checkInDate = :checkInDate")
              #set($expressionNames["#checkInDate"] = "checkInDate")
              #set($expressionValues[":checkInDate"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.checkInDate))
            #end
            #if($ctx.args.input.checkOutDate)
              #set($expression = "$expression, #checkOutDate = :checkOutDate")
              #set($expressionNames["#checkOutDate"] = "checkOutDate")
              #set($expressionValues[":checkOutDate"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.checkOutDate))
            #end
            #if($ctx.args.input.approvalStatus)
              #set($expression = "$expression, #approvalStatus = :approvalStatus")
              #set($expressionNames["#approvalStatus"] = "approvalStatus")
              #set($expressionValues[":approvalStatus"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.approvalStatus))
            #end
            #if($ctx.args.input.promoConsent != $null)
              #set($expression = "$expression, #promoConsent = :promoConsent")
              #set($expressionNames["#promoConsent"] = "promoConsent")
              #set($expressionValues[":promoConsent"] = $util.dynamodb.toDynamoDBJson($ctx.args.input.promoConsent))
            #end
          }
        }
      ResponseMappingTemplate: |
        $util.toJson($ctx.result)

  GetGuestResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getGuest
      DataSourceName: !GetAtt GuestTableDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "GetItem",
          "key": {
            "roomNumber": $util.dynamodb.toDynamoDBJson($ctx.args.roomNumber)
          }
        }
      ResponseMappingTemplate: |
        $util.toJson($ctx.result)

  ListGuestsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listGuests
      DataSourceName: !GetAtt GuestTableDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Scan"
        }
      ResponseMappingTemplate: |
        $util.toJson($ctx.result.items)

  PassportImageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: obw-guest-passport-images
      AccessControl: Private
      VersioningConfiguration:
        Status: Enabled

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      AllowUnauthenticatedIdentities: true

  UnauthRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud": !Ref IdentityPool
              "ForAnyValue:StringLike":
                "cognito-identity.amazonaws.com:amr": unauthenticated
      Policies:
        - PolicyName: AppSyncPublicAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - appsync:GraphQL
                Resource: "*"

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        unauthenticated: !GetAtt UnauthRole.Arn

Outputs:
  ApiEndpoint:
    Description: "AppSync API Endpoint"
    Value: !GetAtt AppSyncApi.GraphQLUrl
  CognitoIdentityPoolId:
    Description: "Cognito Identity Pool ID"
    Value: !Ref IdentityPool