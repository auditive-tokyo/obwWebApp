name: Deploy Security Stack (CloudFront + WAF)

on:
  push:
    branches: [main, feature/*]
    paths:
      - "template-security.yaml"
      - ".github/workflows/security-deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE_ARN }}
          aws-region: us-east-1 # CloudFront„ÅØus-east-1ÂøÖÈ†à

      - name: Set up AWS SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Generate CloudFront Secret
        id: generate_secret
        run: |
          # „É©„É≥„ÉÄ„É†„Å™32ÊñáÂ≠ó„ÅÆËã±Êï∞Â≠ó„ÇíÁîüÊàê
          SECRET=$(openssl rand -hex 32)
          echo "secret=${SECRET}" >> $GITHUB_OUTPUT
          echo "Generated CloudFront secret (hidden)"

      - name: Get ResponseApi Function URL
        id: get_responseapi
        run: |
          URL=$(aws cloudformation describe-stacks \
            --stack-name obw-responseapi-function \
            --region ap-northeast-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`ChatFunctionUrl`].OutputValue' \
            --output text 2>/dev/null || echo "")
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "ResponseApi URL: ${URL}"

      - name: Get ImmediateResponse Function URL
        id: get_immediate
        run: |
          URL=$(aws lambda get-function-url-config \
            --function-name obw-immediate-response-function:live \
            --region ap-northeast-1 \
            --query 'FunctionUrl' \
            --output text 2>/dev/null || echo "")
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "ImmediateResponse URL: ${URL}"

      - name: Deploy Security Stack
        run: |
          sam deploy \
            --template-file template-security.yaml \
            --stack-name obw-security \
            --region us-east-1 \
            --capabilities CAPABILITY_IAM \
            --resolve-s3 \
            --no-confirm-changeset \
            --parameter-overrides \
              ResponseApiFunctionUrl="${{ steps.get_responseapi.outputs.url }}" \
              ImmediateResponseFunctionUrl="${{ steps.get_immediate.outputs.url }}" \
              OriginCustomHeaderSecret="${{ steps.generate_secret.outputs.secret }}" \
            --no-fail-on-empty-changeset

      - name: Get CloudFront URLs from Security Stack
        id: get_cloudfront_urls
        run: |
          echo "=== Getting CloudFront URLs ==="

          # ImmediateResponse CloudFront URL
          IMMEDIATE_CF_URL=$(aws cloudformation describe-stacks \
            --stack-name obw-security \
            --region us-east-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`ImmediateResponseCloudFrontUrl`].OutputValue' \
            --output text 2>/dev/null || echo "")

          # ResponseApi CloudFront URL
          RESPONSEAPI_CF_URL=$(aws cloudformation describe-stacks \
            --stack-name obw-security \
            --region us-east-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`ResponseApiCloudFrontUrl`].OutputValue' \
            --output text 2>/dev/null || echo "")

          echo "immediate_url=${IMMEDIATE_CF_URL}" >> $GITHUB_OUTPUT
          echo "responseapi_url=${RESPONSEAPI_CF_URL}" >> $GITHUB_OUTPUT

          echo "ImmediateResponse CloudFront URL: ${IMMEDIATE_CF_URL}"
          echo "ResponseApi CloudFront URL: ${RESPONSEAPI_CF_URL}"

      - name: Update Twilio Stack with CloudFront URL
        if: steps.get_cloudfront_urls.outputs.immediate_url != ''
        run: |
          echo "=== Updating Twilio Stack with CloudFront URL ==="

          # CloudFront URL„Å®Secret„Åß„Éë„É©„É°„Éº„ÇøÊõ¥Êñ∞ÔºàGitHub Secrets„Åã„ÇâÁõ¥Êé•ÂèñÂæóÔºâ
          aws cloudformation update-stack \
            --stack-name obw-twilio-functions \
            --region ap-northeast-1 \
            --use-previous-template \
            --capabilities CAPABILITY_IAM \
            --parameters \
              ParameterKey=OpenAiApiKey,ParameterValue="${{ secrets.OPENAI_API_KEY }}" \
              ParameterKey=OpenAiVectorStoreId,ParameterValue="${{ secrets.OPENAI_VECTOR_STORE_ID }}" \
              ParameterKey=TwilioAccountSid,ParameterValue="${{ secrets.TWILIO_ACCOUNT_SID }}" \
              ParameterKey=TwilioAuthToken,ParameterValue="${{ secrets.TWILIO_AUTH_TOKEN }}" \
              ParameterKey=ImmediateResponseFunctionUrlParam,ParameterValue="${{ steps.get_cloudfront_urls.outputs.immediate_url }}" \
              ParameterKey=CloudFrontSecret,ParameterValue="${{ steps.generate_secret.outputs.secret }}" \
          || echo "No updates required for Twilio stack"

          echo "‚úÖ Twilio stack updated with CloudFront URL and Secret"

      - name: Update ResponseApi Stack with CloudFront Secret
        if: steps.get_cloudfront_urls.outputs.responseapi_url != ''
        run: |
          echo "=== Updating ResponseApi Stack with CloudFront Secret ==="

          # CloudFront Secret„Åß„Éë„É©„É°„Éº„ÇøÊõ¥Êñ∞ÔºàGitHub Secrets„Åã„ÇâÁõ¥Êé•ÂèñÂæóÔºâ
          aws cloudformation update-stack \
            --stack-name obw-responseapi-function \
            --region ap-northeast-1 \
            --use-previous-template \
            --capabilities CAPABILITY_IAM \
            --parameters \
              ParameterKey=OpenAiApiKey,ParameterValue="${{ secrets.OPENAI_API_KEY }}" \
              ParameterKey=OpenAiVectorStoreId,ParameterValue="${{ secrets.OPENAI_VECTOR_STORE_ID }}" \
              ParameterKey=TelegramBotToken,ParameterValue="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              ParameterKey=TelegramChatId,ParameterValue="${{ secrets.TELEGRAM_CHAT_ID }}" \
              ParameterKey=CloudFrontSecret,ParameterValue="${{ steps.generate_secret.outputs.secret }}" \
          || echo "No updates required for ResponseApi stack"

          echo "‚úÖ ResponseApi stack updated with CloudFront Secret"

      - name: Output Summary
        run: |
          echo "=== Security Stack Deployment Complete ==="
          echo ""
          echo "üìã CloudFront URLs:"
          echo "  ImmediateResponse: ${{ steps.get_cloudfront_urls.outputs.immediate_url }}"
          echo "  ResponseApi: ${{ steps.get_cloudfront_urls.outputs.responseapi_url }}"
          echo ""
          echo "‚úÖ Twilio Lambda updated with CloudFront URL and Secret"
          echo "‚úÖ ResponseApi Lambda updated with CloudFront Secret"
          echo "‚úÖ Lambda functions protected with X-CloudFront-Secret header validation"
          echo "‚úÖ WAF enabled with OWASP rules, IP reputation, and rate limiting"
