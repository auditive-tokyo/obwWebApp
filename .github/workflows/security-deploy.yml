name: Deploy Security Stack (CloudFront + WAF)

on:
  push:
    branches: [main, feature/*]
    paths:
      - "template-security.yaml"
      - ".github/workflows/security-deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE_ARN }}
          aws-region: us-east-1 # CloudFrontã¯us-east-1å¿…é ˆ

      - name: Set up AWS SAM CLI
        uses: aws-actions/setup-sam@v2

      # CloudFront Secretã¯GitHub Secretsã‹ã‚‰å–å¾—ï¼ˆæ¯å›ç”Ÿæˆã™ã‚‹ã¨SnapStartã¨ä¸æ•´åˆãŒèµ·ãã‚‹ï¼‰
      # æ–°ã—ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã™ã‚‹å ´åˆã¯ã€GitHub Secretsã®CLOUDFRONT_SECRETã‚’æ›´æ–°ã—ã€
      # ãã®å¾Œtwilio-deploy.ymlã‚’å®Ÿè¡Œã—ã¦Lambdaã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

      - name: Get ResponseApi Function URL
        id: get_responseapi
        run: |
          URL=$(aws cloudformation describe-stacks \
            --stack-name obw-responseapi-function \
            --region ap-northeast-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`ChatFunctionUrl`].OutputValue' \
            --output text 2>/dev/null || echo "")
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "ResponseApi URL: ${URL}"

      - name: Get ImmediateResponse Function URL
        id: get_immediate
        run: |
          URL=$(aws lambda get-function-url-config \
            --function-name obw-immediate-response-function:live \
            --region ap-northeast-1 \
            --query 'FunctionUrl' \
            --output text 2>/dev/null || echo "")
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "ImmediateResponse URL: ${URL}"

      - name: Deploy Security Stack
        run: |
          sam deploy \
            --template-file template-security.yaml \
            --stack-name obw-security \
            --region us-east-1 \
            --capabilities CAPABILITY_IAM \
            --resolve-s3 \
            --no-confirm-changeset \
            --parameter-overrides \
              ResponseApiFunctionUrl="${{ steps.get_responseapi.outputs.url }}" \
              ImmediateResponseFunctionUrl="${{ steps.get_immediate.outputs.url }}" \
              OriginCustomHeaderSecret="${{ secrets.CLOUDFRONT_SECRET }}" \
            --no-fail-on-empty-changeset

      - name: Output Summary
        run: |
          echo "=== Security Stack Deployment Complete ==="
          echo ""
          echo "ğŸ“‹ CloudFront URLs (from stack outputs):"
          aws cloudformation describe-stacks \
            --stack-name obw-security \
            --region us-east-1 \
            --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue]' \
            --output table
          echo ""
          echo "âš ï¸  é‡è¦: CloudFront URLã‚„Secretã®å¤‰æ›´ã‚’Lambdaã«åæ˜ ã™ã‚‹ã«ã¯ã€"
          echo "   ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
          echo "   - twilio-deploy.yml"
          echo "   - responseapi-deploy.yml"
          echo ""
          echo "âœ… CloudFront distributions configured"
          echo "âœ… WAF enabled with OWASP rules, IP reputation, and rate limiting"
